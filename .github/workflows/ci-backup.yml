name: CI Backup (Manual Rust Installation)

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  test-backup:
    name: Test (Backup)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    strategy:
      matrix:
        rust: [stable, 1.65, 1.70]
        features: [default, serialization]
        exclude:
          - rust: 1.65
            features: serialization
          - rust: 1.70
            features: serialization
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Rustup
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Install Rust ${{ matrix.rust }} (with retry)
      run: |
        for i in {1..3}; do
          echo "Attempt $i to install Rust ${{ matrix.rust }}"
          if rustup toolchain install ${{ matrix.rust }} --components rustfmt,clippy; then
            echo "Successfully installed Rust ${{ matrix.rust }}"
            break
          else
            echo "Attempt $i failed, waiting 10 seconds before retry..."
            sleep 10
          fi
        done
        
    - name: Set default toolchain
      run: rustup default ${{ matrix.rust }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Run tests
      run: cargo test --verbose --features ${{ matrix.features }}
      
    - name: Run examples
      run: |
        cargo run --example basic_usage
        cargo run --example check_holidays
        cargo run --example holiday_info
      if: matrix.rust == 'stable' && matrix.features == 'default'
